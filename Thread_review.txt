from PyQt5.QtCore import *
from kiwoom import Kiwoom
from PyQt5.QtWidgets import *
from PyQt5.QtTest import *


class Thread4(QThread):
    """ìë™ë§¤ë§¤ë¥¼ ë‹´ë‹¹í•˜ëŠ” Thread"""

     # ì‹œê·¸ë„ ì •ì˜
    update_status = pyqtSignal(str)
    trade_done = pyqtSignal(dict)

    def __init__(self, parent):
         super().__init__(parent)
         self.parent = parent

        # í‚¤ì›€ ì¸ìŠ¤í„´ìŠ¤
         self.k = Kiwoom()

         self.prev_volume = {}  # ì¢…ëª©ë³„ ì´ì „ ê±°ë˜ëŸ‰ ì €ì¥ìš©
         self.k.kiwoom.OnReceiveRealData.connect(self.realdata_slot)  # ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì—°ê²°

        # ìë™ë§¤ë§¤ ê´€ë ¨ ë³€ìˆ˜
         self.is_running = False
         self.buy_list = []  # ë§¤ìˆ˜í•  ì¢…ëª© ë¦¬ìŠ¤íŠ¸
         self.buy_amount = 0  # ì¢…ëª©ë‹¹ ë§¤ìˆ˜ ê¸ˆì•¡
         self.profit_rate = 0  # ëª©í‘œ ìˆ˜ìµë¥ 
         self.account_num = ""  # ê³„ì¢Œë²ˆí˜¸
         self.bought_stocks = {}  # ë§¤ìˆ˜í•œ ì¢…ëª© ì €ì¥

        # ìŠ¤í¬ë¦°ë²ˆí˜¸
         self.buy_screen = "4001"  # ë§¤ìˆ˜ìš© ìŠ¤í¬ë¦°
         self.sell_screen = "4002"  # ë§¤ë„ìš© ìŠ¤í¬ë¦°
         self.acc_screen = "4003"  # ê³„ì¢Œì¡°íšŒìš© ìŠ¤í¬ë¦°
         self.price_screen = "4004"  # í˜„ì¬ê°€ì¡°íšŒìš© ìŠ¤í¬ë¦°

        # ì´ë²¤íŠ¸ ë£¨í”„
         #self.price_event_loop = QEventLoop()
         #self.current_price_result = 0

        # ìŠ¬ë¡¯ ì—°ê²°
         try:
             self.k.kiwoom.OnReceiveTrData.connect(self.trdata_slot)
             self.k.kiwoom.OnReceiveChejanData.connect(self.chejan_slot)
         except Exception as e:
             print(f"ìŠ¬ë¡¯ ì—°ê²° ì˜¤ë¥˜: {e}")


    def run(self):
        """Thread ì‹¤í–‰"""
        try:
            print("========== ìë™ë§¤ë§¤ ì‹œì‘ ==========")
            self.is_running = True

            # 1. ë§¤ìˆ˜í•  ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            self.get_buy_list()

            for stock in self.buy_list:
                code = stock["ì¢…ëª©ì½”ë“œ"]
                self.k.kiwoom.dynamicCall(
                    "SetRealReg(QString, QString, QString, QString)",
                    "1000", code, "10;20", "1"
                )

            if len(self.buy_list) == 0:
                self.update_status.emit("ë§¤ìˆ˜í•  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.")
                return

            # 2. ì¢…ëª©ë‹¹ ë§¤ìˆ˜ ê¸ˆì•¡ ì„¤ì •
            self.buy_amount = int(self.parent.buy_price.value())
            stock_count = len(self.buy_list)
            total_investment = self.buy_amount * stock_count

            self.profit_rate = self.parent.profit_percent.value()
            self.account_num = self.parent.redaccComboBox.currentText()

            print(f"ê³„ì¢Œë²ˆí˜¸: {self.account_num}")
            print(f"ë§¤ìˆ˜ ì¢…ëª© ìˆ˜: {stock_count}")
            print(f"ì¢…ëª©ë‹¹ ë§¤ìˆ˜ê¸ˆì•¡: {self.buy_amount:,}ì›")
            print(f"ì´ íˆ¬ìê¸ˆì•¡: {total_investment:,}ì›")
            print(f"ëª©í‘œ ìˆ˜ìµë¥ : {self.profit_rate}%")

            # 3. í˜„ì¬ê°€ ì¡°íšŒ í›„ ë§¤ìˆ˜ ì‹¤í–‰

            self.execute_buy_orders_with_price()

            # 4. ë§¤ìˆ˜ í›„ ì ì‹œ ëŒ€ê¸°
            print("\në§¤ìˆ˜ ì£¼ë¬¸ ì™„ë£Œ. 10ì´ˆ í›„ ëª¨ë‹ˆí„°ë§ ì‹œì‘...")
            QTest.qWait(10000)  # 10ì´ˆ ëŒ€ê¸°

            # 5. ìì²´ ëª¨ë‹ˆí„°ë§ ë° ë§¤ë„
            self.self_monitor_and_sell()

        except Exception as e:
            print(f"ìë™ë§¤ë§¤ Thread ì˜¤ë¥˜: {e}")
            import traceback
            traceback.print_exc()
            self.update_status.emit(f"ìë™ë§¤ë§¤ ì˜¤ë¥˜: {str(e)}")

    def realdata_slot(self, code, real_type, real_data):
        if real_type != "ì£¼ì‹ì²´ê²°":
            return

        try:
            current_volume = int(self.k.kiwoom.GetCommRealData(code, 10).strip())
            strength = float(self.k.kiwoom.GetCommRealData(code, 20).strip())

            prev_volume = self.prev_volume.get(code, current_volume)
            delta_volume = current_volume - prev_volume

            prev_delta = self.prev_volume.get(f"{code}_delta", delta_volume)

            if prev_delta > 0 and delta_volume >= prev_delta * 5 and strength >= 105:
                print(f"ğŸ“ˆ ì¡°ê±´ ë§Œì¡±: {code} | ê±°ë˜ëŸ‰ 5ë°°â†‘, ì²´ê²°ê°•ë„ {strength}%")
                self.update_status.emit(f"{code} ê±°ë˜ëŸ‰ ê¸‰ì¦ + ì²´ê²°ê°•ë„ ê°•í•¨")

            self.prev_volume[code] = current_volume
            self.prev_volume[f"{code}_delta"] = delta_volume

        except Exception as e:
            print(f"ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜: {e}")

    def get_buy_list(self):
        """buylists í…Œì´ë¸”ì—ì„œ ë§¤ìˆ˜í•  ì¢…ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°"""
        self.buy_list = []

        for row in range(self.parent.buylists.rowCount()):
            code_item = self.parent.buylists.item(row, 0)
            name_item = self.parent.buylists.item(row, 1)
            price_item = self.parent.buylists.item(row, 2)  # ê°€ê²© ì •ë³´ë„ ê°€ì ¸ì˜¤ê¸°

            if code_item and name_item:
                code = code_item.text()
                name = name_item.text()

                # ê°€ê²© íŒŒì‹±
                price = 0
                if price_item:
                    price_text = price_item.text().replace(",", "")
                    try:
                        price = int(price_text)
                    except:
                        price = 0

                self.buy_list.append({
                    "ì¢…ëª©ì½”ë“œ": code,
                    "ì¢…ëª©ëª…": name,
                    "í˜„ì¬ê°€": price  # ê°€ê²© ì¶”ê°€
                })

                self.bought_stocks[code] = {
                    "ì¢…ëª©ëª…": name,
                    "ë§¤ìˆ˜ì™„ë£Œ": False
                }

        print(f"ë§¤ìˆ˜ ëŒ€ìƒ ì¢…ëª©: {self.buy_list}")


    def get_current_price(self, code):
        """ì¢…ëª©ì˜ í˜„ì¬ê°€ ì¡°íšŒ (ê°„ë‹¨ ë²„ì „)"""
        try:
            print(f"  í˜„ì¬ê°€ ì¡°íšŒ ì¤‘: {code}")

            self.k.kiwoom.dynamicCall("SetInputValue(QString, QString)", "ì¢…ëª©ì½”ë“œ", code)
            ret = self.k.kiwoom.dynamicCall("CommRqData(QString, QString, int, QString)",
                                            "ì£¼ì‹ê¸°ë³¸ì •ë³´", "opt10001", 0, self.price_screen)

            if ret == 0:
                self.price_event_loop.exec_()  # ì‘ë‹µ ëŒ€ê¸°
                return abs(self.current_price_result) if self.current_price_result else 0
            else:
                print(f"  í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨")
                return 0

        except Exception as e:
            print(f"  í˜„ì¬ê°€ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return 0

    def execute_buy_orders_with_price(self):
         """ì§€ì •ê°€ë¡œ ì •í™•í•œ ê¸ˆì•¡ ë§¤ìˆ˜"""

         for stock in self.buy_list:
            if not self.is_running:
                break

            code = stock["ì¢…ëª©ì½”ë“œ"]
            name = stock["ì¢…ëª©ëª…"]

            print(f"\në§¤ìˆ˜ ì²˜ë¦¬: {code} {name}")
            print(f"  ëª©í‘œ ë§¤ìˆ˜ê¸ˆì•¡: {self.buy_amount:,}ì›")

            try:
                # ìƒí•œê°€ ì¡°íšŒ
                upper_limit = self.k.kiwoom.dynamicCall("GetMasterLastPrice(QString)", code)
                if not upper_limit or upper_limit == "":
                    upper_limit = 100000  # ê¸°ë³¸ê°’
                else:
                    upper_limit = abs(int(upper_limit))
                    # ìƒí•œê°€ë³´ë‹¤ ì•½ê°„ ë†’ê²Œ ì„¤ì • (ì¦‰ì‹œ ì²´ê²° ìœ ë„)
                    upper_limit = int(upper_limit * 1.05)

                print(f"  ì§€ì •ê°€: {upper_limit:,}ì›")

                # ê¸ˆì•¡ ê¸°ì¤€ ìˆ˜ëŸ‰ ê³„ì‚°
                quantity = int(self.buy_amount / upper_limit)
                quantity = max(1, quantity)

                print(f"  ë§¤ìˆ˜ ìˆ˜ëŸ‰: {quantity}ì£¼")
                print(f"  ìµœëŒ€ ê¸ˆì•¡: {quantity * upper_limit:,}ì›")

                # ì§€ì •ê°€ ë§¤ìˆ˜ (ì‹œì¥ê°€ë³´ë‹¤ ë†’ê²Œ ì„¤ì •í•˜ì—¬ ì¦‰ì‹œ ì²´ê²°)
                order_result = self.k.kiwoom.dynamicCall(
                    "SendOrder(QString, QString, QString, int, QString, int, int, QString, QString)",
                    ["ë§¤ìˆ˜ì£¼ë¬¸", self.buy_screen, self.account_num, 1, code, quantity, upper_limit, "00", ""]
                    # "00": ì§€ì •ê°€ ì£¼ë¬¸
                )

                if order_result == 0:
                    self.update_status.emit(f"{name} {quantity}ì£¼ ì£¼ë¬¸")
                    print(f"  >>> ì£¼ë¬¸ ì„±ê³µ")
                else:
                    print(f"  >>> ì£¼ë¬¸ ì‹¤íŒ¨: {order_result}")

            except Exception as e:
                print(f"  ì˜¤ë¥˜: {e}")

            QTest.qWait(1000)

    def self_monitor_and_sell(self):
        """ìì²´ì ìœ¼ë¡œ ê³„ì¢Œ ì¡°íšŒí•˜ë©° ìµì ˆ ê°ì‹œ"""
        print("\n========== ìì²´ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ==========")

        monitor_count = 0
        while self.is_running:
            monitor_count += 1
            print(f"\n--- ëª¨ë‹ˆí„°ë§ #{monitor_count} ---")

            try:
                # ê³„ì¢Œí‰ê°€ì”ê³  ì¡°íšŒ
                self.request_account_evaluation()

                # ë³´ìœ ì¢…ëª© í™•ì¸ ë° ìµì ˆ ì²˜ë¦¬
                self.check_and_sell_positions()

                # ëª¨ë“  ì¢…ëª©ì´ ë§¤ë„ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if len(self.bought_stocks) == 0:
                    print("ëª¨ë“  ì¢…ëª© ë§¤ë„ ì™„ë£Œ. ìë™ë§¤ë§¤ ì¢…ë£Œ")
                    break

            except Exception as e:
                print(f"ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: {e}")

            # 30ì´ˆ ê°„ê²©ìœ¼ë¡œ ì²´í¬
            print("30ì´ˆ í›„ ë‹¤ì‹œ ì²´í¬...")
            for i in range(30):
                if not self.is_running:
                    break
                QTest.qWait(1000)


    def self_monitor_and_sell(self):
        """ìì²´ì ìœ¼ë¡œ ê³„ì¢Œ ì¡°íšŒí•˜ë©° ìµì ˆ ê°ì‹œ"""
        print("\n========== ìì²´ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ==========")

        monitor_count = 0
        while self.is_running:
            monitor_count += 1
            print(f"\n--- ëª¨ë‹ˆí„°ë§ #{monitor_count} ---")

            try:
                # ê³„ì¢Œí‰ê°€ì”ê³  ì¡°íšŒ
                self.request_account_evaluation()

                # ë³´ìœ ì¢…ëª© í™•ì¸ ë° ìµì ˆ ì²˜ë¦¬
                self.check_and_sell_positions()

                # ëª¨ë“  ì¢…ëª©ì´ ë§¤ë„ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if len(self.bought_stocks) == 0:
                    print("ëª¨ë“  ì¢…ëª© ë§¤ë„ ì™„ë£Œ. ìë™ë§¤ë§¤ ì¢…ë£Œ")
                    break

            except Exception as e:
                print(f"ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: {e}")

            # 30ì´ˆ ê°„ê²©ìœ¼ë¡œ ì²´í¬
            print("30ì´ˆ í›„ ë‹¤ì‹œ ì²´í¬...")
            for i in range(30):
                if not self.is_running:
                    break
                QTest.qWait(1000)


    def request_account_evaluation(self):
        """ê³„ì¢Œí‰ê°€ì”ê³  ì¡°íšŒ"""
        try:
            print("ê³„ì¢Œ ì •ë³´ ì¡°íšŒ ì¤‘...")

            # ê³„ì¢Œí‰ê°€ì”ê³ ë‚´ì—­ ìš”ì²­
            self.k.kiwoom.dynamicCall("SetInputValue(String, String)", "ê³„ì¢Œë²ˆí˜¸", self.account_num)
            self.k.kiwoom.dynamicCall("SetInputValue(String, String)", "ë¹„ë°€ë²ˆí˜¸", "0000")
            self.k.kiwoom.dynamicCall("SetInputValue(String, String)", "ë¹„ë°€ë²ˆí˜¸ì…ë ¥ë§¤ì²´êµ¬ë¶„", "00")
            self.k.kiwoom.dynamicCall("SetInputValue(String, String)", "ì¡°íšŒêµ¬ë¶„", "2")

            ret = self.k.kiwoom.dynamicCall("CommRqData(String, String, int, String)",
                                            "ê³„ì¢Œí‰ê°€", "opw00018", 0, self.acc_screen)

            if ret == 0:
                print("ê³„ì¢Œ ì¡°íšŒ ìš”ì²­ ì„±ê³µ")
                QTest.qWait(2000)  # 2ì´ˆ ëŒ€ê¸°
            else:
                print(f"ê³„ì¢Œ ì¡°íšŒ ìš”ì²­ ì‹¤íŒ¨: {ret}")

        except Exception as e:
            print(f"ê³„ì¢Œ ì¡°íšŒ ì˜¤ë¥˜: {e}")


    def check_and_sell_positions(self):
        """ë³´ìœ ì¢…ëª© í™•ì¸ ë° ìµì ˆ ë§¤ë„"""
        try:
            # k.acc_portfolioì—ì„œ ë³´ìœ ì¢…ëª© ì •ë³´ í™•ì¸
            if not hasattr(self.k, 'acc_portfolio') or not self.k.acc_portfolio:
                print("ë³´ìœ ì¢…ëª© ì •ë³´ ì—†ìŒ")
                return

            print(f"ë³´ìœ ì¢…ëª© ìˆ˜: {len(self.k.acc_portfolio)}")

            for code, info in self.k.acc_portfolio.items():
                # ë§¤ìˆ˜í•œ ì¢…ëª©ì¸ì§€ í™•ì¸
                if code not in self.bought_stocks:
                    continue

                name = info.get("ì¢…ëª©ëª…", "")
                current_rate = info.get("ìˆ˜ìµë¥ (%)", 0)
                quantity = info.get("ë³´ìœ ìˆ˜ëŸ‰", 0)
                current_price = info.get("í˜„ì¬ê°€", 0)

                print(f"  {code} {name}: ìˆ˜ìµë¥  {current_rate:.2f}%, í˜„ì¬ê°€ {current_price:,}ì›")

                # ëª©í‘œ ìˆ˜ìµë¥  ë„ë‹¬ í™•ì¸
                if current_rate >= self.profit_rate and quantity > 0:
                    print(f"  >>> ìµì ˆ ì¡°ê±´ ë‹¬ì„±! ë§¤ë„ ì£¼ë¬¸ ì‹¤í–‰")

                    # ì‹œì¥ê°€ ë§¤ë„ ì£¼ë¬¸
                    order_result = self.k.kiwoom.dynamicCall(
                        "SendOrder(QString, QString, QString, int, QString, int, int, QString, QString)",
                        ["ë§¤ë„ì£¼ë¬¸", self.sell_screen, self.account_num, 2, code, quantity, 0, "03", ""]
                    )

                    if order_result == 0:
                        self.update_status.emit(f"{name} ìµì ˆ ë§¤ë„ ì£¼ë¬¸ ({current_rate:.2f}%)")
                        self.trade_done.emit({
                            "ì¢…ëª©ì½”ë“œ": code,
                            "ì¢…ëª©ëª…": name,
                            "ìˆ˜ìµë¥ ": current_rate,
                            "ë§¤ë§¤êµ¬ë¶„": "ë§¤ë„"
                        })
                        print(f"  ë§¤ë„ ì£¼ë¬¸ ì„±ê³µ")

                        # ë§¤ë„í•œ ì¢…ëª©ì€ ëª©ë¡ì—ì„œ ì œê±°
                        del self.bought_stocks[code]
                    else:
                        self.update_status.emit(f"{name} ë§¤ë„ ì‹¤íŒ¨")
                        print(f"  ë§¤ë„ ì£¼ë¬¸ ì‹¤íŒ¨: {order_result}")

        except Exception as e:
            print(f"ìµì ˆ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")


    def stop(self):
        """ìë™ë§¤ë§¤ ì¤‘ì§€"""
        self.is_running = False
        self.update_status.emit("ìë™ë§¤ë§¤ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.")
        print("========== ìë™ë§¤ë§¤ ì¢…ë£Œ ==========")


    def trdata_slot(self, sScrNo, sRQName, sTrCode, sRecordName, sPrevNext):
        """TR ë°ì´í„° ìˆ˜ì‹ """
        try:
            # # í˜„ì¬ê°€ ì¡°íšŒ ì‘ë‹µ
            # if sRQName == "ì£¼ì‹ê¸°ë³¸ì •ë³´":
            #     current_price = self.k.kiwoom.dynamicCall(
            #         "GetCommData(QString, QString, int, QString)",
            #         sTrCode, sRQName, 0, "í˜„ì¬ê°€"
            #     ).strip()
            #
            #     self.current_price_result = int(current_price.replace("+", "").replace("-", ""))
            #     print(f"    í˜„ì¬ê°€ ìˆ˜ì‹ : {self.current_price_result:,}ì›")
            #
            #     if hasattr(self, 'price_event_loop') and self.price_event_loop:
            #         self.price_event_loop.exit()

            # ê³„ì¢Œí‰ê°€ ì‘ë‹µ
            if sRQName == "ê³„ì¢Œí‰ê°€" and sTrCode == "opw00018":
                cnt = self.k.kiwoom.dynamicCall("GetRepeatCnt(QString, QString)", sTrCode, sRQName)
                print(f"TR ìˆ˜ì‹ : ë³´ìœ ì¢…ëª© {cnt}ê°œ")

                for i in range(cnt):
                    code = self.k.kiwoom.dynamicCall(
                        "GetCommData(QString, QString, int, QString)",
                        sTrCode, sRQName, i, "ì¢…ëª©ë²ˆí˜¸"
                    ).strip().replace("A", "")

                    if code:
                        name = self.k.kiwoom.dynamicCall(
                            "GetCommData(QString, QString, int, QString)",
                            sTrCode, sRQName, i, "ì¢…ëª©ëª…"
                        ).strip()

                        quantity = int(self.k.kiwoom.dynamicCall(
                            "GetCommData(QString, QString, int, QString)",
                            sTrCode, sRQName, i, "ë³´ìœ ìˆ˜ëŸ‰"
                        ).strip())

                        buy_price = abs(int(self.k.kiwoom.dynamicCall(
                            "GetCommData(QString, QString, int, QString)",
                            sTrCode, sRQName, i, "ë§¤ì…ê°€"
                        ).strip()))

                        current_price = abs(int(self.k.kiwoom.dynamicCall(
                            "GetCommData(QString, QString, int, QString)",
                            sTrCode, sRQName, i, "í˜„ì¬ê°€"
                        ).strip()))

                        profit_rate = float(self.k.kiwoom.dynamicCall(
                            "GetCommData(QString, QString, int, QString)",
                            sTrCode, sRQName, i, "ìˆ˜ìµë¥ (%)"
                        ).strip())

                        # ì‹±ê¸€í†¤ ë”•ì…”ë„ˆë¦¬ ì—…ë°ì´íŠ¸
                        if code not in self.k.acc_portfolio:
                            self.k.acc_portfolio[code] = {}

                        self.k.acc_portfolio[code].update({
                            "ì¢…ëª©ëª…": name,
                            "ë³´ìœ ìˆ˜ëŸ‰": quantity,
                            "ë§¤ì…ê°€": buy_price,
                            "í˜„ì¬ê°€": current_price,
                            "ìˆ˜ìµë¥ (%)": profit_rate
                        })

                print("ê³„ì¢Œ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ")

        except Exception as e:
            print(f"TR ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜: {e}")

    def chejan_slot(self, sGubun, nItemCnt, sFIdList):
        """ì²´ê²° ë°ì´í„° ìˆ˜ì‹ """
        try:
            if sGubun == "0":  # ì£¼ë¬¸ ì²´ê²°
                order_status = self.k.kiwoom.dynamicCall("GetChejanData(int)", 913).strip()
                code = self.k.kiwoom.dynamicCall("GetChejanData(int)", 9001).strip().replace("A", "")
                name = self.k.kiwoom.dynamicCall("GetChejanData(int)", 302).strip()
                order_quantity = self.k.kiwoom.dynamicCall("GetChejanData(int)", 900).strip()
                executed_quantity = self.k.kiwoom.dynamicCall("GetChejanData(int)", 911).strip()
                price = self.k.kiwoom.dynamicCall("GetChejanData(int)", 910).strip()

                print(f"\n>>> ì²´ê²° ì•Œë¦¼ <<<")
                print(f"  ì¢…ëª©: {code} {name}")
                print(f"  ì£¼ë¬¸ìƒíƒœ: {order_status}")
                print(f"  ì²´ê²°ìˆ˜ëŸ‰: {executed_quantity}ì£¼")
                print(f"  ì²´ê²°ê°€: {price}ì›")

                # ì²´ê²° ê¸ˆì•¡ ê³„ì‚°
                if executed_quantity and price:
                    total_amount = int(executed_quantity) * int(price)
                    print(f"  ì²´ê²°ê¸ˆì•¡: {total_amount:,}ì›")

                    # ëª©í‘œ ê¸ˆì•¡ê³¼ ë¹„êµ
                    if code in self.bought_stocks:
                        target_amount = self.bought_stocks[code].get("ëª©í‘œê¸ˆì•¡", 0)
                        if target_amount > 0:
                            diff = total_amount - target_amount
                            if diff > 0:
                                print(f"  âš ï¸ ëª©í‘œê¸ˆì•¡ {target_amount:,}ì› ì´ˆê³¼: +{diff:,}ì›")
                            else:
                                print(f"  âœ“ ëª©í‘œê¸ˆì•¡ {target_amount:,}ì› ë‚´ ì²´ê²°")

                if order_status == "ì²´ê²°":
                    self.update_status.emit(f"{name} ì²´ê²° ì™„ë£Œ ({executed_quantity}ì£¼ Ã— {price}ì›)")

        except Exception as e:
            print(f"ì²´ê²° ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜: {e}")